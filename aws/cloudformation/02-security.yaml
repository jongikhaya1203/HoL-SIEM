AWSTemplateFormatVersion: '2010-09-09'
Description: 'NetworkScanScada - Phase 1: Security Groups and NACLs'

Parameters:
  EnvironmentName:
    Description: Environment name
    Type: String
    Default: production

  AllowedCIDR:
    Description: CIDR allowed for SSH/admin access
    Type: String
    Default: 10.0.0.0/8

Resources:
  # ==================== Security Groups ====================

  # ALB Security Group
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-alb-sg
      GroupDescription: Security group for Application Load Balancer
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS from anywhere
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP from anywhere (redirect to HTTPS)
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-alb-sg
        - Key: Environment
          Value: !Ref EnvironmentName

  # Application Security Group
  ApplicationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-app-sg
      GroupDescription: Security group for application servers
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTPS from ALB
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCIDR
          Description: SSH from allowed CIDR
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-app-sg
        - Key: Environment
          Value: !Ref EnvironmentName

  # Database Security Group
  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-db-sg
      GroupDescription: Security group for Aurora MySQL database
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref ApplicationSecurityGroup
          Description: MySQL from application servers
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-db-sg
        - Key: Environment
          Value: !Ref EnvironmentName

  # Cache Security Group
  CacheSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-cache-sg
      GroupDescription: Security group for ElastiCache Redis
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref ApplicationSecurityGroup
          Description: Redis from application servers
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-cache-sg
        - Key: Environment
          Value: !Ref EnvironmentName

  # Bastion Security Group
  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvironmentName}-bastion-sg
      GroupDescription: Security group for bastion host
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCIDR
          Description: SSH from allowed CIDR
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-bastion-sg
        - Key: Environment
          Value: !Ref EnvironmentName

  # ==================== Network ACLs ====================

  # Public Subnet NACL
  PublicSubnetNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-public-nacl

  PublicSubnetNACLInboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicSubnetNACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 443
        To: 443

  PublicSubnetNACLInboundHTTP:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicSubnetNACL
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 80
        To: 80

  PublicSubnetNACLInboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicSubnetNACL
      RuleNumber: 120
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  PublicSubnetNACLInboundSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicSubnetNACL
      RuleNumber: 130
      Protocol: 6
      RuleAction: allow
      CidrBlock: !Ref AllowedCIDR
      PortRange:
        From: 22
        To: 22

  PublicSubnetNACLOutboundAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PublicSubnetNACL
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0

  PublicSubnet1NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: ${EnvironmentName}-PublicSubnet1Id
      NetworkAclId: !Ref PublicSubnetNACL

  PublicSubnet2NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: ${EnvironmentName}-PublicSubnet2Id
      NetworkAclId: !Ref PublicSubnetNACL

  # Private Subnet NACL
  PrivateSubnetNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-nacl

  PrivateSubnetNACLInboundHTTP:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateSubnetNACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcCIDR
      PortRange:
        From: 80
        To: 80

  PrivateSubnetNACLInboundHTTPS:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateSubnetNACL
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      CidrBlock: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcCIDR
      PortRange:
        From: 443
        To: 443

  PrivateSubnetNACLInboundSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateSubnetNACL
      RuleNumber: 120
      Protocol: 6
      RuleAction: allow
      CidrBlock: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcCIDR
      PortRange:
        From: 22
        To: 22

  PrivateSubnetNACLInboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateSubnetNACL
      RuleNumber: 130
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  PrivateSubnetNACLOutboundAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref PrivateSubnetNACL
      RuleNumber: 100
      Protocol: -1
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0

  PrivateSubnet1NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: ${EnvironmentName}-PrivateSubnet1Id
      NetworkAclId: !Ref PrivateSubnetNACL

  PrivateSubnet2NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: ${EnvironmentName}-PrivateSubnet2Id
      NetworkAclId: !Ref PrivateSubnetNACL

  # Data Subnet NACL
  DataSubnetNACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcId
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-data-nacl

  DataSubnetNACLInboundMySQL:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref DataSubnetNACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      CidrBlock: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcCIDR
      PortRange:
        From: 3306
        To: 3306

  DataSubnetNACLInboundRedis:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref DataSubnetNACL
      RuleNumber: 110
      Protocol: 6
      RuleAction: allow
      CidrBlock: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcCIDR
      PortRange:
        From: 6379
        To: 6379

  DataSubnetNACLInboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref DataSubnetNACL
      RuleNumber: 120
      Protocol: 6
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  DataSubnetNACLOutboundEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref DataSubnetNACL
      RuleNumber: 100
      Protocol: 6
      RuleAction: allow
      Egress: true
      CidrBlock: !ImportValue
        Fn::Sub: ${EnvironmentName}-VpcCIDR
      PortRange:
        From: 1024
        To: 65535

  DataSubnet1NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: ${EnvironmentName}-DataSubnet1Id
      NetworkAclId: !Ref DataSubnetNACL

  DataSubnet2NACLAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !ImportValue
        Fn::Sub: ${EnvironmentName}-DataSubnet2Id
      NetworkAclId: !Ref DataSubnetNACL

Outputs:
  ALBSecurityGroupId:
    Description: ALB Security Group ID
    Value: !Ref ALBSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-ALBSecurityGroupId

  ApplicationSecurityGroupId:
    Description: Application Security Group ID
    Value: !Ref ApplicationSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-ApplicationSecurityGroupId

  DatabaseSecurityGroupId:
    Description: Database Security Group ID
    Value: !Ref DatabaseSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-DatabaseSecurityGroupId

  CacheSecurityGroupId:
    Description: Cache Security Group ID
    Value: !Ref CacheSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-CacheSecurityGroupId

  BastionSecurityGroupId:
    Description: Bastion Security Group ID
    Value: !Ref BastionSecurityGroup
    Export:
      Name: !Sub ${EnvironmentName}-BastionSecurityGroupId
