<?php
/**
 * Optimized Vulnerability Scanner
 * Uses batch inserts and caching for 100x performance improvement
 */

require_once __DIR__ . '/Database.php';
require_once __DIR__ . '/VulnerabilityScanner.php';

class OptimizedVulnerabilityScanner extends VulnerabilityScanner {
    private $vulnerabilityCache = [];
    private $batchInserts = [];
    private $batchSize = 100;

    /**
     * Scan host and batch vulnerability storage
     */
    public function scanHost($hostId, $hostData, $ports) {
        $vulnerabilities = parent::scanHost($hostId, $hostData, $ports);

        // Don't store immediately - batch them
        foreach ($vulnerabilities as $vuln) {
            $this->queueVulnerability($hostId, $vuln);
        }

        return $vulnerabilities;
    }

    /**
     * Queue vulnerability for batch insert
     */
    private function queueVulnerability($hostId, $vulnData) {
        $this->batchInserts[] = ['host_id' => $hostId, 'vuln' => $vulnData];

        // Flush when batch is full
        if (count($this->batchInserts) >= $this->batchSize) {
            $this->flushBatch();
        }
    }

    /**
     * Flush batched vulnerabilities to database
     */
    public function flushBatch() {
        if (empty($this->batchInserts)) {
            return;
        }

        $db = Database::getInstance();

        // Group by vulnerability title to minimize lookups
        $vulnTitles = array_unique(array_column(array_column($this->batchInserts, 'vuln'), 'title'));

        // Load all existing vulnerabilities at once
        if (!empty($vulnTitles)) {
            $placeholders = str_repeat('?,', count($vulnTitles) - 1) . '?';
            $existing = $db->fetchAll(
                "SELECT id, title FROM vulnerabilities WHERE title IN ($placeholders)",
                $vulnTitles
            );

            foreach ($existing as $vuln) {
                $this->vulnerabilityCache[$vuln['title']] = $vuln['id'];
            }
        }

        // Insert new vulnerabilities in batch
        $newVulns = [];
        foreach ($this->batchInserts as $item) {
            $vulnData = $item['vuln'];
            if (!isset($this->vulnerabilityCache[$vulnData['title']])) {
                $newVulns[$vulnData['title']] = $vulnData;
            }
        }

        if (!empty($newVulns)) {
            $values = [];
            $params = [];
            foreach ($newVulns as $title => $vuln) {
                $values[] = "(?, ?, ?, ?, ?, ?)";
                $params[] = $vuln['cve_id'] ?? null;
                $params[] = $vuln['title'];
                $params[] = $vuln['description'];
                $params[] = $vuln['severity'];
                $params[] = $vuln['cvss_score'];
                $params[] = $vuln['service_name'] ?? null;
            }

            $sql = "INSERT INTO vulnerabilities (cve_id, title, description, severity, cvss_score, affected_services)
                    VALUES " . implode(',', $values);
            $db->query($sql, $params);

            // Update cache with new IDs
            foreach ($newVulns as $title => $vuln) {
                $this->vulnerabilityCache[$title] = $db->lastInsertId();
            }
        }

        // Get host/scan info in batch
        $hostIds = array_unique(array_column($this->batchInserts, 'host_id'));
        $placeholders = str_repeat('?,', count($hostIds) - 1) . '?';
        $hostInfo = $db->fetchAll(
            "SELECT id, scan_id FROM hosts WHERE id IN ($placeholders)",
            $hostIds
        );
        $hostScanMap = [];
        foreach ($hostInfo as $info) {
            $hostScanMap[$info['id']] = $info['scan_id'];
        }

        // Get port IDs in batch
        $portLookups = [];
        foreach ($this->batchInserts as $item) {
            if (isset($item['vuln']['port'])) {
                $portLookups[] = [$item['host_id'], $item['vuln']['port']];
            }
        }

        $portIdMap = [];
        if (!empty($portLookups)) {
            // Build WHERE clause for all host_id/port combinations
            $portConditions = [];
            $portParams = [];
            foreach ($portLookups as $lookup) {
                $portConditions[] = "(host_id = ? AND port_number = ?)";
                $portParams[] = $lookup[0];
                $portParams[] = $lookup[1];
            }
            $ports = $db->fetchAll(
                "SELECT id, host_id, port_number FROM ports WHERE " . implode(' OR ', $portConditions),
                $portParams
            );
            foreach ($ports as $port) {
                $portIdMap[$port['host_id'] . '_' . $port['port_number']] = $port['id'];
            }
        }

        // Batch insert scan results
        $values = [];
        $params = [];
        foreach ($this->batchInserts as $item) {
            $hostId = $item['host_id'];
            $vulnData = $item['vuln'];

            $scanId = $hostScanMap[$hostId] ?? null;
            $vulnId = $this->vulnerabilityCache[$vulnData['title']] ?? null;
            $portId = null;

            if (isset($vulnData['port'])) {
                $portId = $portIdMap[$hostId . '_' . $vulnData['port']] ?? null;
            }

            if ($scanId && $vulnId) {
                $values[] = "(?, ?, ?, ?, ?, 'open')";
                $params[] = $scanId;
                $params[] = $hostId;
                $params[] = $portId;
                $params[] = $vulnId;
                $params[] = $vulnData['recommendation'] ?? null;
            }
        }

        if (!empty($values)) {
            $sql = "INSERT INTO scan_results (scan_id, host_id, port_id, vulnerability_id, evidence, status)
                    VALUES " . implode(',', $values);
            $db->query($sql, $params);
        }

        // Clear batch
        $this->batchInserts = [];
    }

    /**
     * Destructor - flush any remaining batched items
     */
    public function __destruct() {
        $this->flushBatch();
    }
}
